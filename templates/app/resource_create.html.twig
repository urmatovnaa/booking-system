{% extends 'base.html.twig' %}

{% block title %}Создать ресурс{% endblock %}

{% block body %}
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6ebff; }
  main { padding: 24px; }
  section { background: #0f1833; border: 1px solid #1a2547; border-radius: 10px; padding: 16px; max-width: 720px; }
  input, textarea, button, select { background: #0c1430; color: #e6ebff; border: 1px solid #203160; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
  button { cursor: pointer; background: #2a47b8; border-color: #3758d6; }
  button.secondary { background: #0c1430; }
  .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  .muted { color:#93a6ff; font-size:12px; }
  .error { color: #ff97a0; }
  .ok { color: #8de78d; }
</style>

<main>
  <a href="/resources" class="muted">← Назад к списку</a>
  <h2>Создать ресурс</h2>
  <section>
    <div id="msg" class="muted"></div>
    <div class="row">
      <input id="name" placeholder="Название" required />
      <select id="status">
        <option value="active">active</option>
        <option value="inactive">inactive</option>
      </select>
    </div>
    <div class="row">
      <textarea id="description" placeholder="Описание" style="width:100%; min-height:100px;"></textarea>
    </div>
    <div class="row">
      <button id="createBtn">Создать</button>
      <a href="/resources" style="text-decoration: none;"><button class="secondary">Отмена</button></a>
    </div>
  </section>
</main>

<script>
  (function() {
    'use strict';
    
    // Prevent multiple executions
    if (window.resourceCreateInitialized) {
      return;
    }
    window.resourceCreateInitialized = true;
    
    const token = localStorage.getItem('jwt_token');
    if (!token) { 
      window.location.href = '/login';
      return;
    }
    
    const headers = { 
      'Content-Type': 'application/json', 
      'Authorization': `Bearer ${token}` 
    };
    
    const resourceApi = async (path, opts = {}) => {
      try {
        const res = await fetch(path, { 
          method: opts.method || 'GET',
          headers: { ...headers, ...(opts.headers || {}) },
          body: opts.body || undefined
        });
        
        const text = await res.text();
        let data = {};
        
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (e) {
            console.error('Failed to parse JSON:', text);
            data = { raw: text };
          }
        }
        
        if (!res.ok) {
          const error = new Error(data.error || 'Request failed');
          error.data = data;
          error.status = res.status;
          throw error;
        }
        
        return data;
      } catch (e) {
        if (e.data) throw e;
        throw { error: e.message || 'Network error', data: {} };
      }
    };

    const createBtn = document.getElementById('createBtn');
    if (!createBtn) {
      console.error('Create button not found!');
      return;
    }

    createBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const msg = document.getElementById('msg');
      if (!msg) {
        console.error('Message element not found!');
        return;
      }
      
      msg.textContent = '';
      msg.className = 'muted';
      
      const nameInput = document.getElementById('name');
      const statusSelect = document.getElementById('status');
      const descriptionInput = document.getElementById('description');
      
      if (!nameInput || !statusSelect) {
        msg.textContent = 'Ошибка: не найдены поля формы';
        msg.className = 'error';
        return;
      }
      
      const name = nameInput.value.trim();
      if (!name) {
        msg.textContent = 'Название обязательно';
        msg.className = 'error';
        return;
      }
      
      const body = {
        name: name,
        status: statusSelect.value || 'active',
        description: descriptionInput ? descriptionInput.value.trim() || null : null,
      };
      
      msg.textContent = 'Создание...';
      createBtn.disabled = true;
      
      try {
        console.log('Sending request:', body);
        const response = await resourceApi('/api/resources', { 
          method: 'POST', 
          body: JSON.stringify(body) 
        });
        
        console.log('Response received:', response);
        
        if (response.resourceId) {
          window.location.href = `/resources/${response.resourceId}`;
        } else {
          msg.textContent = 'Ресурс создан, но ID не получен';
          msg.className = 'error';
          createBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error creating resource:', error);
        const errorMsg = error?.data?.error || 
                        (error?.data?.errors && Array.isArray(error.data.errors) ? error.data.errors.join(', ') : '') ||
                        error?.error || 
                        'Ошибка при создании ресурса';
        msg.textContent = errorMsg;
        msg.className = 'error';
        createBtn.disabled = false;
      }
    });
  })();
</script>
{% endblock %}

