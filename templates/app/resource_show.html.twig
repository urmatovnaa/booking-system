{% extends 'base.html.twig' %}

{% block title %}Ресурс #{{ id }}{% endblock %}

{% block body %}
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6ebff; }
  main { padding: 24px; }
  section { background: #0f1833; border: 1px solid #1a2547; border-radius: 10px; padding: 16px; max-width: 720px; }
  input, button, select, textarea { background: #0c1430; color: #e6ebff; border: 1px solid #203160; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
  button { cursor: pointer; background: #2a47b8; border-color: #3758d6; }
  button.secondary { background: #0c1430; }
  button.danger { background: #b82a2a; border-color: #d63737; }
  button:disabled { opacity: 0.6; cursor: not-allowed; }
  .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  .muted { color:#93a6ff; font-size:12px; }
  .error { color: #ff97a0; }
  .ok { color: #8de78d; }
  .full-width { width: 100%; }
  .form-group { margin-bottom: 16px; }
  label { display: block; margin-bottom: 4px; color: #cfe0ff; font-size: 14px; }
</style>

<main>
  <a href="/resources" class="muted" data-turbo="false">← Назад к списку ресурсов</a>
  <h2>Ресурс #{{ id }}</h2>
  <section>
    <div id="msg" class="muted"></div>
    
    <div class="form-group">
      <label for="name">Название</label>
      <input id="name" type="text" required class="full-width" />
    </div>
    
    <div class="form-group">
      <label for="description">Описание</label>
      <textarea id="description" class="full-width" rows="3"></textarea>
    </div>
    
    <div class="form-group">
      <label for="type">Тип</label>
      <input id="type" type="text" class="full-width" />
    </div>
    
    <div class="form-group">
      <label for="status">Статус</label>
      <select id="status" class="full-width">
        <option value="active">active</option>
        <option value="inactive">inactive</option>
      </select>
    </div>
    
    <div class="row">
      <button id="updateBtn">Обновить</button>
      <button type="button" class="secondary" onclick="window.location.href='/resources'">Отмена</button>
      <button id="deleteBtn" class="danger">Удалить</button>
    </div>
  </section>
</main>

<script>
  (function() {
    'use strict';
    
    const resourceId = {{ id }};
    const token = localStorage.getItem('jwt_token');
    if (!token) { 
      window.location.href = '/login';
      return;
    }
    
    const headers = { 
      'Content-Type': 'application/json', 
      'Authorization': `Bearer ${token}` 
    };
    
    const api = async (path, opts = {}) => {
      try {
        const res = await fetch(path, { 
          method: opts.method || 'GET',
          headers: { ...headers, ...(opts.headers || {}) },
          body: opts.body || undefined
        });
        
        const text = await res.text();
        let data = {};
        
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (e) {
            console.error('Failed to parse JSON:', text);
            data = { raw: text };
          }
        }
        
        if (!res.ok) {
          const error = new Error(data.error || 'Request failed');
          error.data = data;
          error.status = res.status;
          throw error;
        }
        
        return data;
      } catch (e) {
        if (e.data) throw e;
        throw { error: e.message || 'Network error', data: {} };
      }
    };

    function showMessage(text, type = 'muted') {
      const msg = document.getElementById('msg');
      if (msg) {
        msg.textContent = text;
        msg.className = type;
      }
    }

    // Load resource data
    async function loadResource() {
      try {
        const resource = await api(`/api/resources/${resourceId}`);
        document.getElementById('name').value = resource.name || '';
        document.getElementById('description').value = resource.description || '';
        document.getElementById('type').value = resource.type || '';
        document.getElementById('status').value = resource.status || 'active';
      } catch(e) {
        showMessage('Не удалось загрузить данные ресурса', 'error');
      }
    }

    // Initialize the page
    function init() {
      loadResource();
      
      const updateBtn = document.getElementById('updateBtn');
      const deleteBtn = document.getElementById('deleteBtn');

      // Update resource
      if (updateBtn) {
        updateBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          
          const name = document.getElementById('name')?.value;
          const description = document.getElementById('description')?.value;
          const type = document.getElementById('type')?.value;
          const status = document.getElementById('status')?.value;
          
          if (!name) {
            showMessage('Название обязательно', 'error');
            return;
          }
          
          const body = {
            name: name,
            description: description,
            type: type,
            status: status || 'active',
          };
          
          showMessage('Обновление...', 'muted');
          updateBtn.disabled = true;
          
          try {
            const response = await api(`/api/resources/${resourceId}`, { 
              method: 'PUT', 
              body: JSON.stringify(body) 
            });
            
            showMessage('Ресурс успешно обновлен!', 'ok');
            setTimeout(() => {
              window.location.href = '/resources';
            }, 1000);
            
          } catch(error) {
            console.error('Error updating resource:', error);
            const errorMsg = error?.data?.error || 'Ошибка при обновлении ресурса';
            showMessage(errorMsg, 'error');
            updateBtn.disabled = false;
          }
        });
      }

      // Delete resource
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          
          if (!confirm('Вы уверены, что хотите удалить этот ресурс?')) {
            return;
          }
          
          showMessage('Удаление...', 'muted');
          deleteBtn.disabled = true;
          
          try {
            await api(`/api/resources/${resourceId}`, { 
              method: 'DELETE' 
            });
            
            showMessage('Ресурс успешно удален! Перенаправление...', 'ok');
            setTimeout(() => {
              window.location.href = '/resources';
            }, 1000);
            
          } catch(error) {
            console.error('Error deleting resource:', error);
            const errorMsg = error?.data?.error || 'Ошибка при удалении ресурса';
            showMessage(errorMsg, 'error');
            deleteBtn.disabled = false;
          }
        });
      }
    }

    // Start initialization
    init();
  })();
</script>
{% endblock %}