{% extends 'base.html.twig' %}

{% block title %}Booking {{ id }}{% endblock %}

{% block body %}
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6ebff; }
  main { padding: 24px; }
  section { background: #0f1833; border: 1px solid #1a2547; border-radius: 10px; padding: 16px; max-width: 720px; }
  input, button { background: #0c1430; color: #e6ebff; border: 1px solid #203160; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
  button { cursor: pointer; background: #2a47b8; border-color: #3758d6; }
  button.danger { background: #8a1538; border-color: #b01c47; }
  .row { display:flex; gap:8px; align-items:center; }
  .muted { color:#93a6ff; font-size:12px; }
</style>

<main>
  <a href="/" class="muted">← Назад</a>
  <h2>Бронь #{{ id }}</h2>
  <section>
    <div id="msg" class="muted"></div>
    <div id="info" class="muted" style="margin-bottom:8px;"></div>
    <div class="row" style="margin-bottom:8px;">
      <input id="startTime" type="datetime-local" />
      <input id="endTime" type="datetime-local" />
      <input id="status" placeholder="Status" />
    </div>
    <div class="row">
      <button id="saveBtn">Сохранить</button>
      <button id="deleteBtn" class="danger">Удалить</button>
    </div>
  </section>
  
</main>

<script>
  const id = {{ id }};
  const token = localStorage.getItem('jwt_token');
  const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
  const api = async (path, opts={}) => {
    const res = await fetch(path, { ...opts, headers: { ...headers, ...(opts.headers||{}) } });
    const text = await res.text();
    const data = text ? JSON.parse(text) : {};
    if (!res.ok) throw data;
    return data;
  };

  function toLocalInput(dtStr) {
    // dtStr in "YYYY-MM-DD HH:mm:ss" -> input datetime-local value
    const d = dtStr?.replace(' ', 'T');
    return d?.slice(0,16) || '';
  }

  async function load() {
    try {
      const b = await api(`/api/bookings/${id}`);
      document.getElementById('info').textContent = `Ресурс: ${b.resource?.id} ${b.resource?.name || ''}`;
      document.getElementById('status').value = b.status || '';
      document.getElementById('startTime').value = toLocalInput(b.startTime);
      document.getElementById('endTime').value = toLocalInput(b.endTime);
    } catch (e) {
      document.getElementById('msg').textContent = e?.error || 'Failed to load';
    }
  }
  load();

  document.getElementById('saveBtn').onclick = async () => {
    const body = {};
    const st = document.getElementById('startTime').value;
    const et = document.getElementById('endTime').value;
    const status = document.getElementById('status').value;
    if (st) body.startTime = st; if (et) body.endTime = et; if (status) body.status = status;
    try { await api(`/api/bookings/${id}`, { method: 'PUT', body: JSON.stringify(body) }); location.href = '/'; }
    catch(e){ document.getElementById('msg').textContent = e?.error || 'Failed to save'; }
  };
  document.getElementById('deleteBtn').onclick = async () => {
    try { await api(`/api/bookings/${id}`, { method: 'DELETE' }); location.href = '/'; }
    catch(e){ document.getElementById('msg').textContent = e?.error || 'Failed to delete'; }
  };
</script>
{% endblock %}


