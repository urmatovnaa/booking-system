{% extends 'base.html.twig' %}

{% block title %}Booking {{ id }}{% endblock %}

{% block body %}
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6ebff; }
  main { padding: 24px; }
  section { background: #0f1833; border: 1px solid #1a2547; border-radius: 10px; padding: 16px; max-width: 720px; }
  input, button { background: #0c1430; color: #e6ebff; border: 1px solid #203160; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
  button { cursor: pointer; background: #2a47b8; border-color: #3758d6; }
  button.danger { background: #8a1538; border-color: #b01c47; }
  .row { display:flex; gap:8px; align-items:center; }
  .muted { color:#93a6ff; font-size:12px; }
</style>

<main>
  <a href="/bookings" class="muted">← Назад к списку</a>
  <h2>Бронь #{{ id }}</h2>
  <section>
    <div id="msg" class="muted"></div>
    <div id="info" class="muted" style="margin-bottom:8px;"></div>
    <div class="row" style="margin-bottom:8px;">
      <input id="startTime" type="datetime-local" />
      <input id="endTime" type="datetime-local" />
      <input id="status" placeholder="Status" />
    </div>
    <div class="row">
      <button id="saveBtn">Сохранить</button>
      <button id="deleteBtn" class="danger">Удалить</button>
    </div>
  </section>
  
</main>

<script>
  (function() {
    'use strict';
    
    // Prevent multiple executions
    const initKey = 'bookingShow_' + {{ id }};
    if (window[initKey]) {
      return;
    }
    window[initKey] = true;
    
    const bookingId = {{ id }};
    const token = localStorage.getItem('jwt_token');
    if (!token) {
      window.location.href = '/login';
      return;
    }
    
    const headers = { 
      'Content-Type': 'application/json', 
      'Authorization': `Bearer ${token}` 
    };
    
    const bookingShowApi = async (path, opts = {}) => {
      try {
        const res = await fetch(path, { 
          method: opts.method || 'GET',
          headers: { ...headers, ...(opts.headers || {}) },
          body: opts.body || undefined
        });
        
        const text = await res.text();
        let data = {};
        
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (e) {
            console.error('Failed to parse JSON:', text);
            data = { raw: text };
          }
        }
        
        if (!res.ok) {
          const error = new Error(data.error || 'Request failed');
          error.data = data;
          error.status = res.status;
          throw error;
        }
        
        return data;
      } catch (e) {
        if (e.data) throw e;
        throw { error: e.message || 'Network error', data: {} };
      }
    };

    function toLocalInput(dtStr) {
      const d = dtStr?.replace(' ', 'T');
      return d?.slice(0,16) || '';
    }

    async function loadBooking() {
      try {
        const b = await bookingShowApi(`/api/bookings/${bookingId}`);
        const infoEl = document.getElementById('info');
        const statusEl = document.getElementById('status');
        const startEl = document.getElementById('startTime');
        const endEl = document.getElementById('endTime');
        
        if (infoEl) infoEl.textContent = `Ресурс: ${b.resource?.id} ${b.resource?.name || ''}`;
        if (statusEl) statusEl.value = b.status || '';
        if (startEl) startEl.value = toLocalInput(b.startTime);
        if (endEl) endEl.value = toLocalInput(b.endTime);
      } catch (e) {
        const msg = document.getElementById('msg');
        if (msg) {
          msg.textContent = e?.data?.error || e?.error || 'Failed to load';
          msg.className = 'error';
        }
      }
    }
    loadBooking();

    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const msg = document.getElementById('msg');
        const startEl = document.getElementById('startTime');
        const endEl = document.getElementById('endTime');
        const statusEl = document.getElementById('status');
        
        if (!startEl || !endEl || !statusEl) return;
        
        const body = {};
        const st = startEl.value;
        const et = endEl.value;
        const status = statusEl.value;
        if (st) body.startTime = st;
        if (et) body.endTime = et;
        if (status) body.status = status;
        
        if (msg) {
          msg.textContent = 'Сохранение...';
          msg.className = 'muted';
        }
        saveBtn.disabled = true;
        
        try {
          await bookingShowApi(`/api/bookings/${bookingId}`, { 
            method: 'PUT', 
            body: JSON.stringify(body) 
          });
          window.location.href = '/bookings';
        } catch(e) {
          if (msg) {
            msg.textContent = e?.data?.error || e?.error || 'Failed to save';
            msg.className = 'error';
          }
          saveBtn.disabled = false;
        }
      });
    }

    const deleteBtn = document.getElementById('deleteBtn');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (!confirm('Вы уверены, что хотите удалить эту бронь?')) {
          return;
        }
        
        const msg = document.getElementById('msg');
        if (msg) {
          msg.textContent = 'Удаление...';
          msg.className = 'muted';
        }
        deleteBtn.disabled = true;
        
        try {
          await bookingShowApi(`/api/bookings/${bookingId}`, { method: 'DELETE' });
          window.location.href = '/bookings';
        } catch(e) {
          if (msg) {
            msg.textContent = e?.data?.error || e?.error || 'Failed to delete';
            msg.className = 'error';
          }
          deleteBtn.disabled = false;
        }
      });
    }
  })();
</script>
{% endblock %}


