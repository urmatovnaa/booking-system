{% extends 'base.html.twig' %}

{% block title %}Booking System{% endblock %}

{% block body %}
<style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6ebff; }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 24px; border-bottom: 1px solid #19213c; position: sticky; top:0; background:#0b1020; z-index:10; }
    header h1 { margin:0; font-size:18px; font-weight:600; color:#c9d4ff; }
    .token { font-size:12px; color:#9fb0ff; word-break: break-all; max-width: 70vw; }
    main { display:grid; grid-template-columns: 1fr; gap: 24px; padding: 24px; }
    section { background: #0f1833; border: 1px solid #1a2547; border-radius: 10px; padding: 16px; }
    section h2 { margin: 0 0 12px; font-size: 16px; color: #cfe0ff; }
    form { display: grid; gap: 8px; margin-bottom: 12px; }
    input, select, button, textarea { background: #0c1430; color: #e6ebff; border: 1px solid #203160; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
    button { cursor: pointer; background: #2a47b8; border-color: #3758d6; }
    button.secondary { background: #0c1430; }
    .row { display:flex; gap:8px; align-items:center; }
    .list { display:grid; gap:8px; }
    .card { border:1px solid #203160; border-radius:8px; padding:8px; background:#0b1431; }
    .muted { color:#93a6ff; font-size:12px; }
    .error { color: #ff97a0; }
    .ok { color: #8de78d; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hidden { display:none; }
    footer { padding: 16px 24px; border-top:1px solid #19213c; color:#8aa2ff; font-size:12px; }
</style>

<header>
  <h1>Booking System</h1>
  <div class="row">
    <span id="authStatus" class="muted">Not authenticated</span>
    <button id="logoutBtn" class="secondary hidden">Logout</button>
  </div>
  </header>

<main>
  <section id="authChooser">
    <h2>Добро пожаловать</h2>
    <div class="row">
      <button id="showLogin" class="secondary">Войти</button>
      <button id="showRegister">Зарегистрироваться</button>
    </div>
  </section>

  <section id="registerSection" class="hidden">
    <h2>Регистрация</h2>
    <form id="registerForm">
      <input name="email" type="email" placeholder="Email" required />
      <input name="password" type="password" placeholder="Password" required />
      <button type="submit">Создать аккаунт</button>
    </form>
    <div id="registerMsg" class="muted"></div>
  </section>

  <section id="loginSection" class="hidden">
    <h2>Вход</h2>
    <form id="loginForm">
      <input name="email" type="email" placeholder="Email" required />
      <input name="password" type="password" placeholder="Password" required />
      <button type="submit">Войти</button>
    </form>
    <div id="loginMsg" class="muted"></div>
  </section>

  <section id="resourcesSection" class="hidden">
    <h2>Мои ресурсы</h2>
    <div class="row">
      <label class="muted">Статус:</label>
      <select id="resourceStatus">
        <option value="">Все</option>
        <option value="active">active</option>
        <option value="inactive">inactive</option>
      </select>
      <button id="loadResourcesBtn" class="secondary">Обновить</button>
      <a href="/resources/create" style="text-decoration: none;"><button>Добавить ресурс</button></a>
    </div>
    <div id="resourcesList" class="list"></div>
  </section>

  <section id="bookingsSection" class="hidden">
    <h2>Мои брони</h2>
    <div class="row">
      <label class="muted">Статус:</label>
      <select id="bookingStatus">
        <option value="">Все</option>
        <option value="confirmed">confirmed</option>
        <option value="pending">pending</option>
        <option value="cancelled">cancelled</option>
      </select>
      <button id="loadBookingsBtn" class="secondary">Обновить</button>
      <a href="/bookings/create" style="text-decoration: none;"><button>Добавить бронь</button></a>
    </div>
    <div id="bookingsList" class="list"></div>
  </section>
</main>

<footer>
  API endpoints used: /api/register, /api/auth, /api/resources, /api/bookings
  <span class="muted">(Authorization: Bearer &lt;token&gt;)</span>
  </footer>

<script>
  const qs = (s, root = document) => root.querySelector(s);
  const ce = (tag, props = {}) => Object.assign(document.createElement(tag), props);

  // page hint from server
  window.appPage = '{{ page|default('') }}';

  const tokenKey = 'jwt_token';
  const authStatus = qs('#authStatus');
  const logoutBtn = qs('#logoutBtn');

  function getToken() { return localStorage.getItem(tokenKey) || ''; }
  function setToken(token) { localStorage.setItem(tokenKey, token); renderAuthState(); }
  function clearToken() { localStorage.removeItem(tokenKey); renderAuthState(); }

  function renderAuthState() {
    const t = getToken();
    const authed = Boolean(t);
    authStatus.textContent = authed ? 'Authenticated' : 'Not authenticated';
    logoutBtn.classList.toggle('hidden', !authed);
  }

  async function api(path, { method = 'GET', body, auth = true } = {}) {
    const headers = { 'Content-Type': 'application/json' };
    if (auth) {
      const t = getToken();
      if (t) headers['Authorization'] = `Bearer ${t}`;
    }
    const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : undefined });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
    if (!res.ok) throw Object.assign(new Error('Request failed'), { status: res.status, data });
    return data;
  }

  // Auth view toggles
  const registerSection = qs('#registerSection');
  const loginSection = qs('#loginSection');
  const authChooser = qs('#authChooser');
  qs('#showLogin').addEventListener('click', ()=>{ registerSection.classList.add('hidden'); loginSection.classList.remove('hidden'); });
  qs('#showRegister').addEventListener('click', ()=>{ loginSection.classList.add('hidden'); registerSection.classList.remove('hidden'); });

  // Register
  qs('#registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const email = fd.get('email');
    const password = fd.get('password');
    const msg = qs('#registerMsg');
    msg.textContent = '';
    try {
      await api('/api/register', { method: 'POST', auth: false, body: { email, password } });
      // redirect to login after successful registration
      window.location.href = '/login';
    } catch (err) {
      msg.textContent = err?.data?.error || 'Registration failed';
      msg.className = 'error';
    }
  });

  // Login
  qs('#loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const email = fd.get('email');
    const password = fd.get('password');
    const msg = qs('#loginMsg');
    msg.textContent = '';
    try {
      const data = await api('/api/auth', { method: 'POST', auth: false, body: { email, password } });
      setToken(data.token);
      // redirect to bookings after login
      window.location.href = '/bookings';
    } catch (err) {
      msg.textContent = err?.data?.error || 'Login failed';
      msg.className = 'error';
    }
  });

  logoutBtn.addEventListener('click', () => { clearToken(); window.location.href = '/login'; });

  // Resources
  const resourcesList = qs('#resourcesList');
  async function loadResources() {
    resourcesList.textContent = 'Loading...';
    try {
      const status = qs('#resourceStatus').value;
      const items = await api(`/api/resources${status ? `?status=${encodeURIComponent(status)}` : ''}`);
      renderResources(items);
    } catch (err) {
      resourcesList.textContent = err?.data?.error || 'Failed to load resources';
    }
  }

  function renderResources(items) {
    resourcesList.textContent = '';
    if (!Array.isArray(items) || items.length === 0) {
      resourcesList.append(ce('div', { className: 'muted', textContent: 'No resources yet' }));
      return;
    }
    for (const r of items) {
      const card = ce('div', { className: 'card' });
      const title = ce('div', { textContent: `#${r.id} • ${r.name} (${r.status})` });
      const desc = ce('div', { className: 'muted', textContent: r.description || '' });
      const link = ce('a', { href: `/resources/${r.id}`, textContent: 'Открыть' });
      const linkRow = ce('div', { className: 'row' });
      linkRow.append(link);
      card.append(title, desc, linkRow);
      resourcesList.append(card);
    }
  }

  qs('#loadResourcesBtn').addEventListener('click', loadResources);

  // Bookings
  const bookingsList = qs('#bookingsList');
  async function loadBookings() {
    bookingsList.textContent = 'Loading...';
    try {
      const status = qs('#bookingStatus').value;
      const items = await api(`/api/bookings${status ? `?status=${encodeURIComponent(status)}` : ''}`);
      renderBookings(items);
    } catch (err) {
      bookingsList.textContent = err?.data?.error || 'Failed to load bookings';
    }
  }
  function renderBookings(items) {
    bookingsList.textContent = '';
    if (!Array.isArray(items) || items.length === 0) {
      bookingsList.append(ce('div', { className: 'muted', textContent: 'No bookings yet' }));
      return;
    }
    for (const b of items) {
      const card = ce('div', { className: 'card' });
      card.append(
        ce('div', { textContent: `#${b.id} • res:${b.resource?.id} ${b.resource?.name || ''} • ${b.status}` }),
        ce('div', { className: 'muted', textContent: `${b.startTime} → ${b.endTime}` })
      );
      const link = ce('a', { href: `/bookings/${b.id}`, textContent: 'Открыть' });
      const linkRow = ce('div', { className: 'row' });
      linkRow.append(link);
      card.append(linkRow);
      bookingsList.append(card);
    }
  }
  qs('#loadBookingsBtn').addEventListener('click', loadBookings);

  // Initial
  function renderPageForAuth() {
    const authed = Boolean(getToken());
    const page = window.appPage || '';
    
    // If trying to access protected pages without auth, redirect to login
    if (!authed && (page === 'resources' || page === 'bookings')) {
      window.location.href = '/login';
      return;
    }
    
    // Show/hide auth sections
    authChooser.classList.toggle('hidden', authed);
    registerSection.classList.toggle('hidden', authed || page !== '');
    loginSection.classList.toggle('hidden', authed || page !== 'login');
    
    // Show/hide content sections based on page and auth
    const resourcesSection = qs('#resourcesSection');
    const bookingsSection = qs('#bookingsSection');
    
    if (!authed) {
      // Not authenticated - hide all content sections
      if (resourcesSection) resourcesSection.classList.add('hidden');
      if (bookingsSection) bookingsSection.classList.add('hidden');
    } else {
      // Authenticated - show appropriate section based on page
      if (page === 'resources') {
        if (resourcesSection) resourcesSection.classList.remove('hidden');
        if (bookingsSection) bookingsSection.classList.add('hidden');
        loadResources();
      } else if (page === 'bookings') {
        if (resourcesSection) resourcesSection.classList.add('hidden');
        if (bookingsSection) bookingsSection.classList.remove('hidden');
        loadBookings();
      } else {
        // Default page - show both sections
        if (resourcesSection) resourcesSection.classList.remove('hidden');
        if (bookingsSection) bookingsSection.classList.remove('hidden');
        loadResources();
        loadBookings();
      }
    }
  }
  renderAuthState();
  renderPageForAuth();
</script>
{% endblock %}


