{% extends 'base.html.twig' %}

{% block title %}Booking System{% endblock %}

{% block body %}
<style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6ebff; }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 24px; border-bottom: 1px solid #19213c; position: sticky; top:0; background:#0b1020; z-index:10; }
    header h1 { margin:0; font-size:18px; font-weight:600; color:#c9d4ff; }
    .token { font-size:12px; color:#9fb0ff; word-break: break-all; max-width: 70vw; }
    main { display:grid; grid-template-columns: 1fr; gap: 24px; padding: 24px; }
    section { background: #0f1833; border: 1px solid #1a2547; border-radius: 10px; padding: 16px; }
    section h2 { margin: 0 0 12px; font-size: 16px; color: #cfe0ff; }
    form { display: grid; gap: 8px; margin-bottom: 12px; }
    input, select, button, textarea { background: #0c1430; color: #e6ebff; border: 1px solid #203160; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
    button { cursor: pointer; background: #2a47b8; border-color: #3758d6; }
    button.secondary { background: #0c1430; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .list { display:grid; gap:8px; }
    .card { border:1px solid #203160; border-radius:8px; padding:8px; background:#0b1431; }
    .muted { color:#93a6ff; font-size:12px; }
    .error { color: #ff97a0; }
    .ok { color: #8de78d; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hidden { display:none !important; }
    footer { padding: 16px 24px; border-top:1px solid #19213c; color:#8aa2ff; font-size:12px; }
    .nav { display: flex; gap: 12px; margin-bottom: 16px; }
    .nav a { color: #9fb0ff; text-decoration: none; padding: 8px 16px; border-radius: 6px; border: 1px solid #203160; }
    .nav a.active { background: #2a47b8; color: white; border-color: #3758d6; }
</style>

<header>
  <h1>Booking System</h1>
  <div class="row">
    <span id="authStatus" class="muted">Not authenticated</span>
    <button id="logoutBtn" class="secondary hidden">Logout</button>
  </div>
</header>

<main>
  <!-- Навигация для авторизованных пользователей -->
  <nav id="mainNav" class="nav hidden">
    <a href="/bookings" id="navBookings" data-turbo="false">Мои бронирования</a>
    <a href="/resources" id="navResources" data-turbo="false">Мои ресурсы</a>
  </nav>

  <section id="authChooser">
    <h2>Добро пожаловать</h2>
    <div class="row">
      <button id="showLogin" class="secondary" onclick="window.location.href='/login'">Войти</button>
      <button id="showRegister" onclick="window.location.href='/register'">Зарегистрироваться</button>
    </div>
  </section>

  <section id="registerSection" class="hidden">
    <h2>Регистрация</h2>
    <form id="registerForm">
      <input name="email" type="email" placeholder="Email" required />
      <input name="password" type="password" placeholder="Password" required />
      <button type="submit">Создать аккаунт</button>
    </form>
    <div class="row">
      <span class="muted">Уже есть аккаунт?</span>
      <a href="/login" style="color: #9fb0ff;" data-turbo="false">Войти</a>
    </div>
    <div id="registerMsg" class="muted"></div>
  </section>

  <section id="loginSection" class="hidden">
    <h2>Вход</h2>
    <form id="loginForm">
      <input name="email" type="email" placeholder="Email" required />
      <input name="password" type="password" placeholder="Password" required />
      <button type="submit">Войти</button>
    </form>
    <div class="row">
      <span class="muted">Нет аккаунта?</span>
      <a href="/register" style="color: #9fb0ff;" data-turbo="false">Зарегистрироваться</a>
    </div>
    <div id="loginMsg" class="muted"></div>
  </section>

  <section id="resourcesSection" class="hidden">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <h2>Мои ресурсы</h2>
      <a href="/resources/create" style="text-decoration: none;" data-turbo="false">
        <button>Добавить ресурс</button>
      </a>
    </div>
    
    <div class="row">
      <label class="muted">Название:</label>
      <input id="resourceNameFilter" type="text" placeholder="Фильтр по названию" />
      <label class="muted">Статус:</label>
      <select id="resourceStatus">
        <option value="">Все</option>
        <option value="active">active</option>
        <option value="inactive">inactive</option>
      </select>
      <button id="loadResourcesBtn" class="secondary">Обновить</button>
    </div>
    
    <div id="resourcesList" class="list"></div>
  </section>

  <section id="bookingsSection" class="hidden">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <h2>Мои бронирования</h2>
      <a href="/bookings/create" style="text-decoration: none;" data-turbo="false">
        <button>Добавить бронь</button>
      </a>
    </div>
    
    <div class="row">
      <label class="muted">Статус:</label>
      <select id="bookingStatus">
        <option value="">Все</option>
        <option value="confirmed">confirmed</option>
        <option value="pending">pending</option>
        <option value="cancelled">cancelled</option>
      </select>
      <button id="loadBookingsBtn" class="secondary">Обновить</button>
    </div>
    
    <div id="bookingsList" class="list"></div>
  </section>
</main>

<footer>
  API endpoints used: /api/register, /api/auth, /api/resources, /api/bookings
  <span class="muted">(Authorization: Bearer &lt;token&gt;)</span>
</footer>

<script>
// Отключаем Turbo полностью
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Turbo !== 'undefined') {
        Turbo.session.drive = false;
        console.log('Turbo Drive disabled');
    }
});

// Основная инициализация
document.addEventListener('DOMContentLoaded', init);

function init() {
    'use strict';
    
    // Prevent multiple executions
    if (window.bookingSystemInitialized) {
        console.log('Booking System already initialized, skipping...');
        return;
    }
    window.bookingSystemInitialized = true;
    
    console.log('Booking System initialized');
    
    // Utility functions
    const qs = (selector, root = document) => root.querySelector(selector);
    const ce = (tag, props = {}) => Object.assign(document.createElement(tag), props);
    
    // Page configuration
    const page = '{{ page|default("") }}';
    const tokenKey = 'jwt_token';
    
    console.log('Current page:', page);
    
    // Auth state management
    const getToken = () => localStorage.getItem(tokenKey) || '';
    const setToken = (token) => {
        localStorage.setItem(tokenKey, token);
        renderAuthState();
    };
    const clearToken = () => {
        localStorage.removeItem(tokenKey);
        renderAuthState();
    };
    
    // API function
    async function api(path, { method = 'GET', body, auth = true } = {}) {
        const headers = { 'Content-Type': 'application/json' };
        if (auth) {
            const t = getToken();
            if (t) headers['Authorization'] = `Bearer ${t}`;
        }
        
        console.log(`API call: ${method} ${path}`);
        
        const res = await fetch(path, { 
            method, 
            headers, 
            body: body ? JSON.stringify(body) : undefined 
        });
        
        const text = await res.text();
        let data;
        try { 
            data = text ? JSON.parse(text) : {}; 
        } catch { 
            data = { raw: text }; 
        }
        
        if (!res.ok) {
            throw Object.assign(new Error('Request failed'), { 
                status: res.status, 
                data 
            });
        }
        
        return data;
    }
    
    // Render auth state
    function renderAuthState() {
        const token = getToken();
        const isAuthenticated = Boolean(token);
        
        const authStatus = qs('#authStatus');
        const logoutBtn = qs('#logoutBtn');
        const mainNav = qs('#mainNav');
        
        if (authStatus) {
            authStatus.textContent = isAuthenticated ? 'Authenticated' : 'Not authenticated';
        }
        
        if (logoutBtn) {
            logoutBtn.classList.toggle('hidden', !isAuthenticated);
        }
        
        if (mainNav) {
            mainNav.classList.toggle('hidden', !isAuthenticated);
        }
        
        console.log('Auth state rendered:', isAuthenticated);
    }
    
    // Show/hide sections based on page and auth
    function renderPage() {
        const token = getToken();
        const isAuthenticated = Boolean(token);
        
        console.log('Rendering page, authenticated:', isAuthenticated);
        
        // Hide all sections first
        const sections = [
            'authChooser',
            'registerSection', 
            'loginSection',
            'resourcesSection',
            'bookingsSection'
        ];
        
        sections.forEach(sectionId => {
            const section = qs(`#${sectionId}`);
            if (section) {
                section.classList.add('hidden');
            }
        });
        
        // Show appropriate section based on page and auth state
        if (!isAuthenticated) {
            if (page === 'register') {
                showSection('registerSection');
            } else if (page === 'login') {
                showSection('loginSection');
            } else {
                showSection('authChooser');
            }
        } else {
            if (page === 'resources') {
                showSection('resourcesSection');
                loadResources();
            } else if (page === 'bookings' || page === '') {
                showSection('bookingsSection');
                loadBookings();
            } else {
                showSection('bookingsSection');
                loadBookings();
            }
        }
        
        highlightActiveNav();
    }
    
    function showSection(sectionId) {
        const section = qs(`#${sectionId}`);
        if (section) {
            section.classList.remove('hidden');
            console.log('Showing section:', sectionId);
        }
    }
    
    function highlightActiveNav() {
        const currentPath = window.location.pathname;
        const navBookings = qs('#navBookings');
        const navResources = qs('#navResources');
        
        if (navBookings) {
            navBookings.classList.toggle('active', currentPath === '/bookings' || currentPath === '/');
        }
        if (navResources) {
            navResources.classList.toggle('active', currentPath === '/resources');
        }
    }
    
    // Auth event handlers
    function setupAuthHandlers() {
        // Show login/register sections - теперь перенаправляем на отдельные страницы
        const showLoginBtn = qs('#showLogin');
        const showRegisterBtn = qs('#showRegister');
        
        if (showLoginBtn) {
            showLoginBtn.addEventListener('click', () => {
                window.location.href = '/login';
            });
        }
        
        if (showRegisterBtn) {
            showRegisterBtn.addEventListener('click', () => {
                window.location.href = '/register';
            });
        }
        
        // Register form
        const registerForm = qs('#registerForm');
        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(registerForm);
                const email = formData.get('email');
                const password = formData.get('password');
                const msg = qs('#registerMsg');
                
                if (msg) {
                    msg.textContent = '';
                    msg.className = 'muted';
                }
                
                try {
                    await api('/api/register', { 
                        method: 'POST', 
                        auth: false, 
                        body: { email, password } 
                    });
                    
                    if (msg) {
                        msg.textContent = 'Регистрация успешна! Перенаправление на вход...';
                        msg.className = 'ok';
                    }
                    
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                    
                } catch (err) {
                    if (msg) {
                        msg.textContent = err?.data?.error || 'Registration failed';
                        msg.className = 'error';
                    }
                }
            });
        }
        
        // Login form
        const loginForm = qs('#loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(loginForm);
                const email = formData.get('email');
                const password = formData.get('password');
                const msg = qs('#loginMsg');
                
                if (msg) {
                    msg.textContent = '';
                    msg.className = 'muted';
                }
                
                try {
                    const data = await api('/api/auth', { 
                        method: 'POST', 
                        auth: false, 
                        body: { email, password } 
                    });
                    
                    setToken(data.token);
                    
                    if (msg) {
                        msg.textContent = 'Вход успешен! Перенаправление...';
                        msg.className = 'ok';
                    }
                    
                    setTimeout(() => {
                        window.location.href = '/bookings';
                    }, 1000);
                    
                } catch (err) {
                    if (msg) {
                        msg.textContent = err?.data?.error || 'Login failed';
                        msg.className = 'error';
                    }
                }
            });
        }
        
        // Logout
        const logoutBtn = qs('#logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                clearToken();
                window.location.href = '/login';
            });
        }
    }
    
    // Resources functionality
    async function loadResources() {
        const resourcesList = qs('#resourcesList');
        if (!resourcesList) return;
        
        resourcesList.textContent = 'Loading...';
        
        try {
            const status = qs('#resourceStatus').value;
            const name = qs('#resourceNameFilter').value;
            
            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (name) params.append('name', name);
            
            const items = await api(`/api/resources?${params.toString()}`);
            renderResources(items);
        } catch (err) {
            resourcesList.textContent = err?.data?.error || 'Failed to load resources';
        }
    }
    
    function renderResources(items) {
        const resourcesList = qs('#resourcesList');
        if (!resourcesList) return;
        
        resourcesList.textContent = '';
        
        if (!Array.isArray(items) || items.length === 0) {
            resourcesList.appendChild(ce('div', { 
                className: 'muted', 
                textContent: 'No resources yet' 
            }));
            return;
        }
        
        items.forEach(resource => {
            const card = ce('div', { className: 'card' });
            const title = ce('div', { 
                textContent: `#${resource.id} • ${resource.name} (${resource.status})` 
            });
            const desc = ce('div', { 
                className: 'muted', 
                textContent: resource.description || '' 
            });
            const link = ce('a', { 
                href: `/resources/${resource.id}`, 
                textContent: 'Открыть',
                style: 'color: #9fb0ff; text-decoration: none;'
            });
            const linkRow = ce('div', { className: 'row' });
            linkRow.appendChild(link);
            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(linkRow);
            resourcesList.appendChild(card);
        });
    }
    
    // Bookings functionality
    async function loadBookings() {
        const bookingsList = qs('#bookingsList');
        if (!bookingsList) return;
        
        bookingsList.textContent = 'Loading...';
        
        try {
            const status = qs('#bookingStatus').value;
            const items = await api(`/api/bookings${status ? `?status=${status}` : ''}`);
            renderBookings(items);
        } catch (err) {
            bookingsList.textContent = err?.data?.error || 'Failed to load bookings';
        }
    }
    
    function renderBookings(items) {
        const bookingsList = qs('#bookingsList');
        if (!bookingsList) return;
        
        bookingsList.textContent = '';
        
        if (!Array.isArray(items) || items.length === 0) {
            bookingsList.appendChild(ce('div', { 
                className: 'muted', 
                textContent: 'No bookings yet' 
            }));
            return;
        }
        
        items.forEach(booking => {
            const card = ce('div', { className: 'card' });
            card.appendChild(ce('div', { 
                textContent: `#${booking.id} • res:${booking.resource?.id} ${booking.resource?.name || ''} • ${booking.status}` 
            }));
            card.appendChild(ce('div', { 
                className: 'muted', 
                textContent: `${booking.startTime} → ${booking.endTime}` 
            }));
            const link = ce('a', { 
                href: `/bookings/${booking.id}`, 
                textContent: 'Открыть',
                style: 'color: #9fb0ff; text-decoration: none;'
            });
            const linkRow = ce('div', { className: 'row' });
            linkRow.appendChild(link);
            card.appendChild(linkRow);
            bookingsList.appendChild(card);
        });
    }
    
    // Setup event listeners
    function setupEventListeners() {
        // Resources
        const loadResourcesBtn = qs('#loadResourcesBtn');
        if (loadResourcesBtn) {
            loadResourcesBtn.addEventListener('click', loadResources);
        }
        
        const resourceNameFilter = qs('#resourceNameFilter');
        if (resourceNameFilter) {
            resourceNameFilter.addEventListener('input', debounce(loadResources, 300));
        }
        
        const resourceStatus = qs('#resourceStatus');
        if (resourceStatus) {
            resourceStatus.addEventListener('change', loadResources);
        }
        
        // Bookings
        const loadBookingsBtn = qs('#loadBookingsBtn');
        if (loadBookingsBtn) {
            loadBookingsBtn.addEventListener('click', loadBookings);
        }
        
        const bookingStatus = qs('#bookingStatus');
        if (bookingStatus) {
            bookingStatus.addEventListener('change', loadBookings);
        }
    }
    
    // Debounce utility
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Initialize application
    function initializeApp() {
        console.log('Initializing application...');
        
        renderAuthState();
        setupAuthHandlers();
        setupEventListeners();
        renderPage();
        
        console.log('Application initialized successfully');
    }
    
    // Start the application
    initializeApp();
}
</script>
{% endblock %}