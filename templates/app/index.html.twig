{% extends 'base.html.twig' %}

{% block title %}Booking System Demo{% endblock %}

{% block body %}
<style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6ebff; }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 24px; border-bottom: 1px solid #19213c; position: sticky; top:0; background:#0b1020; z-index:10; }
    header h1 { margin:0; font-size:18px; font-weight:600; color:#c9d4ff; }
    .token { font-size:12px; color:#9fb0ff; word-break: break-all; max-width: 70vw; }
    main { display:grid; grid-template-columns: 1fr 1fr; gap: 24px; padding: 24px; }
    section { background: #0f1833; border: 1px solid #1a2547; border-radius: 10px; padding: 16px; }
    section h2 { margin: 0 0 12px; font-size: 16px; color: #cfe0ff; }
    form { display: grid; gap: 8px; margin-bottom: 12px; }
    input, select, button, textarea { background: #0c1430; color: #e6ebff; border: 1px solid #203160; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
    button { cursor: pointer; background: #2a47b8; border-color: #3758d6; }
    button.secondary { background: #0c1430; }
    .row { display:flex; gap:8px; align-items:center; }
    .list { display:grid; gap:8px; }
    .card { border:1px solid #203160; border-radius:8px; padding:8px; background:#0b1431; }
    .muted { color:#93a6ff; font-size:12px; }
    .error { color: #ff97a0; }
    .ok { color: #8de78d; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hidden { display:none; }
    footer { padding: 16px 24px; border-top:1px solid #19213c; color:#8aa2ff; font-size:12px; }
</style>

<header>
  <h1>Booking System</h1>
  <div class="row">
    <span id="authStatus" class="muted">Not authenticated</span>
    <button id="logoutBtn" class="secondary hidden">Logout</button>
  </div>
  <div class="token" id="tokenPreview"></div>
  </header>

<main>
  <section>
    <h2>Register</h2>
    <form id="registerForm">
      <input name="email" type="email" placeholder="Email" required />
      <input name="password" type="password" placeholder="Password" required />
      <button type="submit">Create account</button>
    </form>
    <div id="registerMsg" class="muted"></div>
  </section>

  <section>
    <h2>Login</h2>
    <form id="loginForm">
      <input name="email" type="email" placeholder="Email" required />
      <input name="password" type="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <div id="loginMsg" class="muted"></div>
  </section>

  <section>
    <h2>Resources</h2>
    <form id="createResourceForm" class="grid-2">
      <input name="name" placeholder="Name" required />
      <input name="status" placeholder="Status (active/inactive)" value="active" />
      <textarea name="description" placeholder="Description"></textarea>
      <button type="submit">Create resource</button>
    </form>
    <div class="row">
      <button id="loadResourcesBtn" class="secondary">Load my resources</button>
    </div>
    <div id="resourcesList" class="list"></div>
  </section>

  <section>
    <h2>Bookings</h2>
    <form id="createBookingForm" class="grid-2">
      <input name="resourceId" type="number" placeholder="Resource ID" required />
      <input name="startTime" type="datetime-local" required />
      <input name="endTime" type="datetime-local" required />
      <input name="status" placeholder="Status (confirmed/pending)" value="confirmed" />
      <button type="submit">Create booking</button>
    </form>
    <div class="row">
      <button id="loadBookingsBtn" class="secondary">Load bookings</button>
    </div>
    <div id="bookingsList" class="list"></div>
  </section>
</main>

<footer>
  API endpoints used: /api/register, /api/auth, /api/resources, /api/bookings
  <span class="muted">(Authorization: Bearer &lt;token&gt;)</span>
  </footer>

<script>
  const qs = (s, root = document) => root.querySelector(s);
  const ce = (tag, props = {}) => Object.assign(document.createElement(tag), props);

  const tokenKey = 'jwt_token';
  const authStatus = qs('#authStatus');
  const tokenPreview = qs('#tokenPreview');
  const logoutBtn = qs('#logoutBtn');

  function getToken() { return localStorage.getItem(tokenKey) || ''; }
  function setToken(token) { localStorage.setItem(tokenKey, token); renderAuthState(); }
  function clearToken() { localStorage.removeItem(tokenKey); renderAuthState(); }

  function renderAuthState() {
    const t = getToken();
    const authed = Boolean(t);
    authStatus.textContent = authed ? 'Authenticated' : 'Not authenticated';
    tokenPreview.textContent = authed ? `Token: ${t}` : '';
    logoutBtn.classList.toggle('hidden', !authed);
  }

  async function api(path, { method = 'GET', body, auth = true } = {}) {
    const headers = { 'Content-Type': 'application/json' };
    if (auth) {
      const t = getToken();
      if (t) headers['Authorization'] = `Bearer ${t}`;
    }
    const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : undefined });
    const text = await res.text();
    let data;
    try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
    if (!res.ok) throw Object.assign(new Error('Request failed'), { status: res.status, data });
    return data;
  }

  // Register
  qs('#registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const email = fd.get('email');
    const password = fd.get('password');
    const msg = qs('#registerMsg');
    msg.textContent = '';
    try {
      const data = await api('/api/register', { method: 'POST', auth: false, body: { email, password } });
      msg.textContent = `Created user #${data.userId} (${data.email})`;
      msg.className = 'ok';
    } catch (err) {
      msg.textContent = err?.data?.error || 'Registration failed';
      msg.className = 'error';
    }
  });

  // Login
  qs('#loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const email = fd.get('email');
    const password = fd.get('password');
    const msg = qs('#loginMsg');
    msg.textContent = '';
    try {
      const data = await api('/api/auth', { method: 'POST', auth: false, body: { email, password } });
      setToken(data.token);
      msg.textContent = 'Login success';
      msg.className = 'ok';
    } catch (err) {
      msg.textContent = err?.data?.error || 'Login failed';
      msg.className = 'error';
    }
  });

  logoutBtn.addEventListener('click', () => { clearToken(); });

  // Resources
  const resourcesList = qs('#resourcesList');
  async function loadResources() {
    resourcesList.textContent = 'Loading...';
    try {
      const items = await api('/api/resources');
      renderResources(items);
    } catch (err) {
      resourcesList.textContent = err?.data?.error || 'Failed to load resources';
    }
  }

  function renderResources(items) {
    resourcesList.textContent = '';
    if (!Array.isArray(items) || items.length === 0) {
      resourcesList.append(ce('div', { className: 'muted', textContent: 'No resources yet' }));
      return;
    }
    for (const r of items) {
      const card = ce('div', { className: 'card' });
      card.append(
        ce('div', { textContent: `#${r.id} • ${r.name} (${r.status})` }),
        ce('div', { className: 'muted', textContent: r.description || '' }),
        ce('div', { className: 'muted', textContent: `User: ${r.userId}` }),
      );
      const row = ce('div', { className: 'row' });
      const nameI = ce('input', { value: r.name });
      const statusI = ce('input', { value: r.status });
      const descI = ce('input', { value: r.description || '' });
      const saveB = ce('button', { textContent: 'Save' });
      const delB = ce('button', { textContent: 'Delete', className: 'secondary' });
      row.append(nameI, statusI, descI, saveB, delB);
      card.append(row);
      saveB.onclick = async () => {
        try {
          await api(`/api/resources/${r.id}`, { method: 'PUT', body: { name: nameI.value, status: statusI.value, description: descI.value } });
          await loadResources();
        } catch (err) { alert(err?.data?.error || 'Update failed'); }
      };
      delB.onclick = async () => {
        try {
          await api(`/api/resources/${r.id}`, { method: 'DELETE' });
          await loadResources();
        } catch (err) { alert(err?.data?.error || 'Delete failed'); }
      };
      resourcesList.append(card);
    }
  }

  qs('#loadResourcesBtn').addEventListener('click', loadResources);
  qs('#createResourceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const body = { name: fd.get('name'), status: fd.get('status') || 'active', description: fd.get('description') || null };
    try { await api('/api/resources', { method: 'POST', body }); e.currentTarget.reset(); await loadResources(); }
    catch (err) { alert(err?.data?.errors?.join(', ') || err?.data?.error || 'Create failed'); }
  });

  // Bookings
  const bookingsList = qs('#bookingsList');
  async function loadBookings() {
    bookingsList.textContent = 'Loading...';
    try {
      const items = await api('/api/bookings');
      renderBookings(items);
    } catch (err) {
      bookingsList.textContent = err?.data?.error || 'Failed to load bookings';
    }
  }
  function renderBookings(items) {
    bookingsList.textContent = '';
    if (!Array.isArray(items) || items.length === 0) {
      bookingsList.append(ce('div', { className: 'muted', textContent: 'No bookings yet' }));
      return;
    }
    for (const b of items) {
      const card = ce('div', { className: 'card' });
      card.append(
        ce('div', { textContent: `#${b.id} • res:${b.resource?.id} ${b.resource?.name || ''} • ${b.status}` }),
        ce('div', { className: 'muted', textContent: `${b.startTime} → ${b.endTime}` }),
      );
      const row = ce('div', { className: 'row' });
      const startI = ce('input', { type:'datetime-local' });
      const endI = ce('input', { type:'datetime-local' });
      const statusI = ce('input', { value: b.status });
      const saveB = ce('button', { textContent: 'Save' });
      const delB = ce('button', { textContent: 'Delete', className: 'secondary' });
      row.append(startI, endI, statusI, saveB, delB);
      card.append(row);
      saveB.onclick = async () => {
        const body = {};
        if (startI.value) body.startTime = startI.value;
        if (endI.value) body.endTime = endI.value;
        if (statusI.value) body.status = statusI.value;
        try { await api(`/api/bookings/${b.id}`, { method: 'PUT', body }); await loadBookings(); }
        catch (err) { alert(err?.data?.error || 'Update failed'); }
      };
      delB.onclick = async () => {
        try { await api(`/api/bookings/${b.id}`, { method: 'DELETE' }); await loadBookings(); }
        catch (err) { alert(err?.data?.error || 'Delete failed'); }
      };
      bookingsList.append(card);
    }
  }
  qs('#loadBookingsBtn').addEventListener('click', loadBookings);
  qs('#createBookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.currentTarget);
    const body = {
      resourceId: Number(fd.get('resourceId')),
      startTime: fd.get('startTime'),
      endTime: fd.get('endTime'),
      status: fd.get('status') || 'confirmed'
    };
    try { await api('/api/bookings', { method: 'POST', body }); e.currentTarget.reset(); await loadBookings(); }
    catch (err) { alert(err?.data?.errors?.join(', ') || err?.data?.error || 'Create failed'); }
  });

  // Initial
  renderAuthState();
  // Optionally auto-load lists if token present
  if (getToken()) { loadResources(); loadBookings(); }
</script>
{% endblock %}


