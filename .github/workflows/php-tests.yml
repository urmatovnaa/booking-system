name: PHP Tests & Coverage

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      rabbitmq:
        image: rabbitmq:3-management-alpine
        ports:
          - 5672:5672
        options: >-
          --health-cmd="rabbitmq-diagnostics ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, pcov
        coverage: pcov
        tools: composer:v2
    
    - name: Validate composer.json
      run: composer validate --strict
    
    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest --optimize-autoloader
    
    - name: Create .env.test
      run: |
        if [ -f .env.test.dist ]; then
          cp .env.test.dist .env.test
        else
          echo "# Test environment" > .env.test
        fi
        echo "DATABASE_URL=mysql://root:root@127.0.0.1:3306/test_db?serverVersion=8.0&charset=utf8mb4" >> .env.test
        echo "REDIS_HOST=127.0.0.1" >> .env.test
        echo "REDIS_PORT=6379" >> .env.test
        echo "MESSENGER_TRANSPORT_DSN=sync://" >> .env.test
        echo "APP_ENV=test" >> .env.test
        echo "APP_SECRET=testsecret123456789012345678901234" >> .env.test
    
    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h"127.0.0.1" -P"3306" -uroot -proot --silent; then
            echo "MySQL is ready!"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
    
    - name: Setup database
      run: |
        php bin/console doctrine:database:create --env=test --if-not-exists
        php bin/console doctrine:schema:create --env=test
    
    - name: Run PHPUnit tests
      run: |
        vendor/bin/phpunit --coverage-text --coverage-clover=coverage.xml --log-junit=junit.xml
    
    - name: Check code coverage threshold
      id: coverage-check
      run: |
        # Получаем покрытие из вывода PHPUnit
        COVERAGE_OUTPUT=$(vendor/bin/phpunit --coverage-text --coverage-filter=src/ 2>&1 | grep -A5 "Summary:" || echo "")
        
        if [[ -z "$COVERAGE_OUTPUT" ]]; then
          # Альтернативный способ получить покрытие
          COVERAGE=$(grep -o 'lines-covered="[0-9]*"' coverage.xml | sed 's/[^0-9]*//g')
          TOTAL=$(grep -o 'lines-valid="[0-9]*"' coverage.xml | sed 's/[^0-9]*//g')
          if [[ -n "$COVERAGE" && -n "$TOTAL" && "$TOTAL" -gt 0 ]]; then
            COVERAGE_PERCENT=$(echo "scale=2; $COVERAGE * 100 / $TOTAL" | bc)
          else
            COVERAGE_PERCENT=0
          fi
        else
          # Извлекаем процент из текстового вывода
          COVERAGE_PERCENT=$(echo "$COVERAGE_OUTPUT" | grep -E "^\s+Lines:" | awk '{print $3}' | sed 's/%//' || echo "0")
        fi
        
        echo "Code coverage: $COVERAGE_PERCENT%"
        echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
        
        # Проверяем порог (60%)
        if (( $(echo "$COVERAGE_PERCENT < 60" | bc -l) )); then
          echo "❌ Code coverage is below 60% threshold (current: $COVERAGE_PERCENT%)"
          exit 1
        else
          echo "✅ Code coverage meets 60% threshold (current: $COVERAGE_PERCENT%)"
        fi
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: test-results
        path: |
          var/coverage/
          coverage.xml
          junit.xml
        retention-days: 7
    
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: coverage-report
        path: var/coverage/
        retention-days: 7